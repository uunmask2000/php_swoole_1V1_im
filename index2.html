<!DOCTYPE HTML>

<html>
<title>客服端</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<script src="https://code.jquery.com/jquery-2.2.4.js" integrity="sha256-iT6Q9iMJYuQiMWNd9lDyBUStIq/8PuOW33aOqmvFpqI="
    crossorigin="anonymous"></script>
<link rel="stylesheet" type="text/css" href="main.css" />


<head>

    <script type="text/javascript">
        function getCookie(cname) {
            var name = cname + "=";
            var ca = document.cookie.split(';');
            for (var i = 0; i < ca.length; i++) {
                var c = ca[i].trim();
                if (c.indexOf(name) == 0) return c.substring(name.length, c.length);
            }
            return "";
        }

        function setCookie(cname, cvalue, exdays) {
            var d = new Date();
            d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
            var expires = "expires=" + d.toGMTString();
            document.cookie = cname + "=" + cvalue + "; " + expires;
        }

        function push_data(ws, data, id) {
            var msg = {
                'id': id,
                'user_id': $('#set_people').text(),
                data: data
            }
            if (data != "") {
                // $("#msg").append('<li>Server  : ' + data + '</li>');
                $("#" + $('#set_people').text()).append('<li>Server  : ' + data + '</li>');

            }

            ws.send(JSON.stringify(msg));


            var div = document.getElementById($('#set_people').text());
            div.scrollTop = div.scrollHeight; //这里是关键的实现
        }



        // var id = getCookie('id') != "" ? getCookie('id') : setCookie('id', new Date().getTime(), 1);
        var id = 2;


        if ("WebSocket" in window) {
            // alert("WebSocket is supported by your Browser!");

            // Let us open a web socket
            var ws = new WebSocket("ws://103.117.121.146:10184/");

            ws.onopen = function () {
                push_data(ws, '', id);
                // Web Socket is connected, send data using send()
                // var push_data = push_data();
                // ws.send("Message to send");
                // alert("Message is sent...");
            };

            ws.onmessage = function (evt) {
                var received_msg = JSON.parse(evt.data);
                // alert("Message is received..." + received_msg);
                if (received_msg.data != "") {
                    // $("#msg").append('<li>客戶來訊 : ' + received_msg.data + '</li>'); 
                    $('#user_id_' + received_msg.id).append('<li>客戶來訊 : ' + received_msg.data + '</li>');
                }
            };



            ws.onclose = function () {

                // websocket is closed.
                alert("Connection is closed...");
            };
        } else {

            // The browser doesn't support WebSocket
            alert("WebSocket NOT supported by your Browser!");
        }

        function send() {
            var msg = document.getElementById("msgtext").value;
            push_data(ws, msg, id);
            // console.log(msg);
        }



        function Set(d) {
            $('#set_people').html(d);
            // alert(d)
            $('#sse').append('<ul id="' + d + '" class="dropdown nav"></ul>');

            //
            if ($('#' + d + " > li").length == 0) {
                $.getJSON("http://103.117.121.146:10181/Api.php?event=getlist&id=" + d, function (result) {
                    // $.each(result, function (i, field) {
                    //     $("p").append(field + " ");
                    // });
                    // console.log(result);
                    result.data.lists.forEach(element => {
                        var element = JSON.parse(element);
                        var msg = JSON.parse(element.msg);
                        console.log(msg);
                        // 
                        switch (msg.id) {
                            case 2:
                                $('#' + d).append('<li>Server : ' + msg.data + '</li>');
                                break;
                            default:
                                $('#' + d).append('<li>客戶來訊 : ' + msg.data + '</li>');
                                break;
                        }

                    });

                    var div = document.getElementById(d);
                    div.scrollTop = div.scrollHeight; //这里是关键的实现

                });
            }
        }

        $.getJSON("http://103.117.121.146:10181/Api.php?event=lists", function (result) {
            // $.each(result, function (i, field) {
            //     $("p").append(field + " ");
            // });
            // console.log(result);
            result.data.lists.forEach(element => {
                console.log(element);
                $('#lists').append('<tr><td>' + element + '</td><td><button onclick="Set(\'' + element +
                    '\');">設定</button></td></tr>')
            });
        });
    </script>

</head>

<body>

    <table id="lists"></table>
    <div>
        點選客戶
        <p id="set_people"></p>
    </div>
    <div id="sse">
        <ul id="msg"></ul>
    </div>
    <input type="text" id="msgtext" value="hello">
    <button onclick="send()">送出</button>


</body>

</html>